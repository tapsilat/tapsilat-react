name: Publish Package

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: Update module version
        run: |
          MODULE_VERSION="${{ steps.version.outputs.module_version }}"
          perl -0pi -e "s/'version':\s*'[^']+'/'version': '$MODULE_VERSION'/g" package.json

      - name: Commit version bump
        run: |
          MODULE_VERSION="${{ steps.version.outputs.module_version }}"
          if git diff --quiet package.json; then
            echo "No version change detected"
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json
          git commit -m "chore: bump module version to $MODULE_VERSION"
          git push origin main
  publish:
    runs-on: ubuntu-latest
    needs: [version]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # Ensure npm 11.5.1 or later is installed
      - name: Update npm
        run: npm install -g npm@latest
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
      - run: npm publish